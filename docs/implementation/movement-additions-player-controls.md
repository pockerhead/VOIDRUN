Player Control + Gravity Implementation Plan                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ üéØ –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –§–∏–∑–∏–∫–∞: CharacterBody3D + Manual Gravity (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º 3d-rpg) ‚úÖ                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ï–¥–∏–Ω–∞—è –Ω–æ–¥–∞: Actor –¥–ª—è Player + NPC ‚úÖ                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ –û—Ç–ª–∏—á–∏–µ: ECS –∫–æ–º–ø–æ–Ω–µ–Ω—Ç PlayerControlled ‚úÖ                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ Camera: Hybrid First-Person (–≤–∏–¥–∏–º–æ–µ —Ç–µ–ª–æ, RigPivot) ‚úÖ                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ Gravity: 9.8 m/s¬≤ (–∑–µ–º–Ω–∞—è, configurable –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞–Ω–µ—Ç) ‚úÖ                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ---                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÖ Phase 1: Gravity + Jump –¥–ª—è –í–°–ï–• actors (1 –¥–µ–Ω—å)                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Day 1: –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è + Grounding                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ECS Layer:                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Gravity resource (configurable –¥–ª—è –ø–ª–∞–Ω–µ—Ç)                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ velocity.y —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ movement system                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Godot Layer (movement_system.rs):                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ // –í apply_navigation_velocity_main_thread:                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ const GRAVITY: f32 = 9.8; // m/s¬≤ (Earth)                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ const JUMP_SPEED: f32 = 4.5; // m/s (–∫–∞–∫ –≤ 3d-rpg)                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é –∫–∞–∂–¥—ã–π frame                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ if !body.is_on_floor() {                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     velocity.y -= GRAVITY * delta;                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ } else {                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     velocity.y = 0.0; // –ù–∞ –∑–µ–º–ª–µ                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ // –ü—Ä—ã–∂–∫–∏ (–¥–ª—è –≤—Å–µ—Ö —Å JumpIntent)                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ if jump_intent && body.is_on_floor() {                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ     velocity.y = JUMP_SPEED;                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ECS Event:                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ #[derive(Event)]                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub struct JumpIntent {                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     pub entity: Entity,                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ó–∞–¥–∞—á–∏:                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –î–æ–±–∞–≤–∏—Ç—å gravity –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ movement_system.rs                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –î–æ–±–∞–≤–∏—Ç—å JumpIntent event                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: NPC –ø–∞–¥–∞—é—Ç –Ω–∞ –∑–µ–º–ª—é (–Ω–µ –ª–µ—Ç–∞—é—Ç –Ω–∞ Y=0.5)                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Spawn actors –Ω–∞ Y=0.0 (–Ω–µ 0.5)                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ---                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÖ Phase 2: Player Input System (1-2 –¥–Ω—è)                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Day 2: Player Spawn + WASD Movement                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ECS Layer:                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ #[derive(Component)]                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub struct PlayerControlled;                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ #[derive(Event)]                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub struct PlayerInputEvent {                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     pub move_direction: Vec2,      // WASD (normalized)                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     pub look_delta: Vec2,           // Mouse movement                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     pub jump_pressed: bool,                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     pub attack_pressed: bool,                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     pub parry_pressed: bool,                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Godot Layer (player_input.rs - –ù–û–í–´–ô –§–ê–ô–õ):                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ /// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Godot Input ‚Üí PlayerInputEvent                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub fn process_player_input(                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ     player_query: Query<Entity, With<PlayerControlled>>,                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut input_events: EventWriter<PlayerInputEvent>,                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ ) {                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let Ok(player_entity) = player_query.get_single() else {                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return;                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     };                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // WASD input                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let input_dir = Input::get_vector(                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         "move_left", "move_right",                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         "move_forward", "move_back"                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     );                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // Mouse look (–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤ _unhandled_input)                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let look_delta = MOUSE_DELTA.lock().unwrap().take();                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º event                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     input_events.write(PlayerInputEvent {                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         move_direction: Vec2::new(input_dir.x, input_dir.y),                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         look_delta,                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ         jump_pressed: Input::is_action_just_pressed("jump"),                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         attack_pressed: Input::is_action_just_pressed("attack"),                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ         parry_pressed: Input::is_action_just_pressed("parry"),                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     });                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ECS System (player_movement.rs):                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ /// PlayerInputEvent ‚Üí MovementCommand + JumpIntent                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub fn player_movement_system(                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut input_events: EventReader<PlayerInputEvent>,                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ     player_query: Query<Entity, With<PlayerControlled>>,                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut commands: Commands,                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut jump_events: EventWriter<JumpIntent>,                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ ) {                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let Ok(player_entity) = player_query.get_single() else { return };                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     for input in input_events.read() {                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // WASD ‚Üí MovementCommand (existing)                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         if !input.move_direction.is_zero() {                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ             let direction = Vec3::new(                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 input.move_direction.x,                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 0.0,                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 input.move_direction.y                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ             );                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ             commands.entity(player_entity).insert(                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 MovementCommand::MoveToDirection { direction }                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ             );                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         }                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Jump                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         if input.jump_pressed {                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ             jump_events.write(JumpIntent { entity: player_entity });                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ         }                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ó–∞–¥–∞—á–∏:                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –°–æ–∑–¥–∞—Ç—å PlayerControlled –∫–æ–º–ø–æ–Ω–µ–Ω—Ç                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Spawn Player entity (–≤–º–µ—Å—Ç–æ NPC, –∫–Ω–æ–ø–∫–∞ "Spawn Player")                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_input.rs —Å–∏—Å—Ç–µ–º–∞ (Input ‚Üí Events)                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_movement.rs —Å–∏—Å—Ç–µ–º–∞ (Events ‚Üí MovementCommand)                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Mouse capture (Input.mouse_mode = CAPTURED)                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: WASD –¥–≤–∏–∂–µ–Ω–∏–µ, Space –ø—Ä—ã–∂–æ–∫                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ---                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÖ Phase 3: First-Person Camera (1 –¥–µ–Ω—å)                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Day 3: Camera Pivots + Mouse Look                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Godot Spawn (spawn_actor_visuals_main_thread):                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ // –ü–æ—Å–ª–µ spawn actor_node:                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ if has_component::<PlayerControlled>(entity) {                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // Camera pivots (–∫–∞–∫ –≤ 3d-rpg)                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let mut horizontal_pivot = Node3D::new_alloc();                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     horizontal_pivot.set_name("HorizontalPivot");                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ     actor_node.add_child(&horizontal_pivot.upcast::<Node>());                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let mut vertical_pivot = Node3D::new_alloc();                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ     vertical_pivot.set_name("VerticalPivot");                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     horizontal_pivot.add_child(&vertical_pivot.upcast::<Node>());                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // Camera (eye level Y=1.6, –∫–∞–∫ –≤ 3d-rpg)                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let mut camera = Camera3D::new_alloc();                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     camera.set_position(Vector3::new(0.0, 1.6, 0.0));                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     camera.set_current(true); // Active camera                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     vertical_pivot.add_child(&camera.upcast::<Node>());                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // –°–∫—Ä—ã–≤–∞–µ–º labels –¥–ª—è player                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ     visuals.health_labels.get_mut(&entity).unwrap().hide();                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     visuals.stamina_labels.get_mut(&entity).unwrap().hide();                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Camera Look System (player_camera.rs):                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub fn player_camera_look(                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut input_events: EventReader<PlayerInputEvent>,                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ     player_query: Query<Entity, With<PlayerControlled>>,                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     visuals: NonSend<VisualRegistry>,                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ ) {                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let Ok(player_entity) = player_query.get_single() else { return };                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     for input in input_events.read() {                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         let Some(actor_node) = visuals.visuals.get(&player_entity) else {                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ             continue;                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         };                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Horizontal rotation (body + horizontal pivot)                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         let Some(mut h_pivot) = actor_node.try_get_node_as::<Node3D>("HorizontalPivot") else {                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ             continue;                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         };                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         h_pivot.rotate_y(input.look_delta.x);                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Vertical rotation (vertical pivot, clamped)                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         let Some(mut v_pivot) = h_pivot.try_get_node_as::<Node3D>("VerticalPivot") else {                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ             continue;                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         };                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         v_pivot.rotate_x(input.look_delta.y);                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Clamp vertical (-60¬∞ to +10¬∞, –∫–∞–∫ –≤ 3d-rpg)                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         let mut rotation = v_pivot.get_rotation();                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         rotation.x = rotation.x.clamp(                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ             -60.0_f32.to_radians(),                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ             10.0_f32.to_radians()                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ         );                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         v_pivot.set_rotation(rotation);                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ó–∞–¥–∞—á–∏:                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Spawn camera pivots –¥–ª—è PlayerControlled                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_camera.rs —Å–∏—Å—Ç–µ–º–∞ (mouse look)                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Clamp vertical rotation (-60¬∞ to +10¬∞)                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Mouse sensitivity –Ω–∞—Å—Ç—Ä–æ–π–∫–∞                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: smooth camera, no jitter                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ---                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÖ Phase 4: Player Combat Input (1 –¥–µ–Ω—å)                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Day 4: Attack + Parry Input                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ECS System (player_combat.rs):                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ pub fn player_combat_input(                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut input_events: EventReader<PlayerInputEvent>,                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ     player_query: Query<Entity, With<PlayerControlled>>,                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut attack_events: EventWriter<MeleeAttackIntent>,                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ     mut parry_events: EventWriter<ParryIntent>,                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     weapons: Query<&WeaponStats>,                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ ) {                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     let Ok(player_entity) = player_query.get_single() else { return };                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     for input in input_events.read() {                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // LMB ‚Üí Melee Attack                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ         if input.attack_pressed {                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ             // TODO: –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞ (raycast –∏–ª–∏ closest)                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ             let target = find_closest_enemy(player_entity, &visuals);                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ             attack_events.write(MeleeAttackIntent {                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 attacker: player_entity,                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 target,                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 attack_type: MeleeAttackType::Normal,                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ             });                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         }                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // RMB ‚Üí Parry                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         if input.parry_pressed {                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ             // Parry current attacker (if any)                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ             if let Some(attacker) = get_current_attacker(player_entity) {                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 parry_events.write(ParryIntent {                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                     defender: player_entity,                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ                     attacker,                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                     expected_windup_duration: 0.2, // Default                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                 });                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ             }                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ         }                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ó–∞–¥–∞—á–∏:                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_combat.rs —Å–∏—Å—Ç–µ–º–∞                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - LMB ‚Üí MeleeAttackIntent                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ - RMB ‚Üí ParryIntent                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Find closest enemy helper (raycast –æ—Ç camera)                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Crosshair UI (—Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞)                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: –∞—Ç–∞–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ---                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÖ Phase 5: Player HUD + Polish (1 –¥–µ–Ω—å)                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Day 5: HUD + Body Awareness                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ HUD Elements:                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Health bar (bottom-left)                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Stamina bar (below health)                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Crosshair (—Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞)                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Hit indicator (–∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º —É—Ä–æ–Ω)                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ Body Awareness (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, WOW factor):                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Visible arms + weapon (first-person rig)                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Visible legs (–ø—Ä–∏ –≤–∑–≥–ª—è–¥–µ –≤–Ω–∏–∑)                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Camera bob (subtle head movement –ø—Ä–∏ —Ö–æ–¥—å–±–µ)                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ó–∞–¥–∞—á–∏:                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Spawn HUD –¥–ª—è PlayerControlled                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Health/Stamina bars sync                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Crosshair texture                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Hit indicator VFX                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ - (Optional) Visible body setup                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ - Camera bob animation                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: –∏–≥—Ä–∞–µ—à—å 5+ –º–∏–Ω—É—Ç, —á—É–≤—Å—Ç–≤—É–µ—à—å combat!                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ---                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (4-5 –¥–Ω–µ–π):                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ß—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –¥–ª—è –í–°–ï–• actors (9.8 m/s¬≤)                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ –ü—Ä—ã–∂–∫–∏ (Space, 4.5 m/s)                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Player control (WASD movement, mouse look)                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ First-person camera (hybrid, –≤–∏–¥–∏–º–æ–µ —Ç–µ–ª–æ)                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Combat input (LMB attack, RMB parry)                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Player HUD (health, stamina, crosshair)                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ –ò–≥—Ä–∞–µ—à—å –≤ —Å–≤–æ—é –∏–≥—Ä—É!                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –§–∞–π–ª—ã:                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ - movement_system.rs ‚Äî –¥–æ–±–∞–≤–∏—Ç—å gravity                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_input.rs ‚Äî –ù–û–í–´–ô (Input ‚Üí Events)                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_movement.rs ‚Äî –ù–û–í–´–ô (Events ‚Üí MovementCommand)                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_camera.rs ‚Äî –ù–û–í–´–ô (Camera look)                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_combat.rs ‚Äî –ù–û–í–´–ô (Attack/Parry input)                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ - player_hud.rs ‚Äî –ù–û–í–´–ô (HUD spawn + sync)                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ - visual_sync.rs ‚Äî modify (camera spawn –¥–ª—è PlayerControlled)                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ - simulation_bridge.rs ‚Äî add systems                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ CharacterBody3D (–∫–∞–∫ 3d-rpg)                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Manual gravity (configurable)                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ –ï–¥–∏–Ω–∞—è Actor –Ω–æ–¥–∞                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ ECS –∫–æ–º–ø–æ–Ω–µ–Ω—Ç PlayerControlled –¥–ª—è –æ—Ç–ª–∏—á–∏—è                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ - ‚úÖ Hybrid first-person (RigPivot –¥–ª—è body)       